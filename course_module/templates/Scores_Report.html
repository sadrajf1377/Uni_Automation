{% extends 'Base_Layout.html' %}

{% block title %}
کارنامه ترم
{% endblock %}
{% block dynamic_style %}
<style>

table{
    width: 70%;
    margin: 6vh auto;
    border-collapse: collapse;
    direction: rtl;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    border-radius: 12px;
    overflow: hidden;
}

/* هر ردیف، ساختار اصلی حفظ شده */
tr{
    display: flex;
    flex-direction: row;
    width: 100%;
}

/* ردیف عنوان نیمسال */
tr.semester{
    background: #007acc;
    color: white !important;
    font-weight: bold;
    font-size: 1.2rem;
}

td{
    flex: 1; /* ستون‌ها مقیاس ثابت پیدا می‌کنند */
    padding: 1rem .5rem;
    border: 1px solid #dcdcdc;
    text-align: center;
    font-size: 1rem;
    background: #fafafa;
    color: #003b5c;
}

/* رنگ‌بندی راه‌راه بدون به‌هم‌ریختن ساختار */
td:nth-child(odd){
    background: #f0f4f8;
}
td:nth-child(even){
    background: #ffffff;
}

/* فرم اعتراض */
form#appeal_form{
    width: 50vw;
    background: white;
    position: fixed;
    top: 15vh;
    left: 25vw;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.25);
    transform: scale(0);
    transition: .35s ease;
}

form#appeal_form input,
form#appeal_form textarea,
form#appeal_form select{
    width: 90%;
    padding: .7rem;
    margin: .5rem 0;
    border: 1px solid #bfc5d2;
    border-radius: 6px;
    font-size: 1rem;
}

form#appeal_form button{
    width: 92%;
    padding: .8rem;
    margin-top: .8rem;
    font-size: 1rem;
    border: none;
    background: #007acc;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    transition: .25s;
}

form#appeal_form button:hover{
    background: #1e90ff;
}

@media(max-width: 768px){
    table{
        width: 95%;
    }
    td{
        font-size: .9rem;
        padding: .7rem;
    }
    form#appeal_form{
        width: 85vw;
        left: 7.5vw;
    }
}

</style>

{% endblock %}
{% block main_content %}
    <form id="appeal_form" style="transform: scale(0)">
    {% csrf_token %}
    {% for field in appeal_form %}
    {{ field.label }}
        <br>
        {{ field }}
        <br>

    {% endfor %}
    <button onclick="event.preventDefault();submit_score_appeal()">
        ثبت اعتراض
    </button>
    <button onclick="event.preventDefault();open_close_appeal_form('-1')">
        بستن فرم
    </button>
    </form>
<table>
    {% for sem in semesters %}

         <tr class="semester">
        <td >
            نیمسال
        </td>
        <td class="sem_dates">
            {{ sem.start_date }}
        تا
        {{ sem.end_date }}

        </td>

    </tr>
        <tr>
        <td>نام درس</td>
        <td>تعداد واحد</td>
        <td>استاد</td>
        <td>نمره درس</td>
        <td>وضعیت قبولی</td>
        <td>اعتراض به نمره</td>
    </tr>
        {% for course in sem.sem_courses %}
            <tr>
             <td>{{ course.title }}</td>
        <td>{{ course.credits }}</td>
        <td>{{ course.teacher }}</td>
        <td>{{ course.score }}</td>
            <td>{{ course.pass_status }}</td>
            <td>
                {% if course.appeal_text %}
                {{ course.appeal_text }}
                    {% else %}
                    <p onclick="open_close_appeal_form('{{ course.id }}')">
                    ثبت اعتراض به نمره
                    </p>
                {% endif %}
            </td>
            </tr>
            {% endfor %}

         <tr>
          <td>معدل ترم</td>
         <td>{{ sem.sem_average }}</td>
         </tr>
    {% endfor %}
     <tr class="semester">
         <td>
             معدل کل نیمسال ها
         </td>
         <td id="total_avg">
             {{ total_average }}
         </td>
     </tr>
</table>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/moment@2.29.4/moment.js"></script>

<!-- بعد moment-jalaali -->
<script src="https://unpkg.com/moment-jalaali@0.9.2/build/moment-jalaali.js"></script>



<script>

  moment.loadPersian();
  const appeal_form=document.querySelector('form#appeal_form');
  let course_to_appeal_id='';
  const csrf_token=document.getElementsByName('csrfmiddlewaretoken')[0].value;
  function open_close_appeal_form(score_id)
  {
      const should_close_form=score_id=='-1';
      course_to_appeal_id=should_close_form?course_to_appeal_id:score_id;
      appeal_form.style.transform=should_close_form?'scale(0)':'scale(1)';
  }
  function submit_score_appeal()
  {
      const data=new FormData(appeal_form)
    fetch('submit_appeal/'+course_to_appeal_id,{method:"POST",body:data,headers:{"X-csrftoken":csrf_token}}).then(res=>res.json()).then(res=>{
        console.log(res)
    }).catch(res=>{console.log(res)})
  }
 const dates=document.querySelectorAll('.sem_dates');
 for (const element of dates){
     const dates_split=element.innerHTML.split('تا');
     const date1 = new Date(dates_split[0]);
     const date2 = new Date(dates_split[1]);
     const text=`
     از
     ${moment(date1).format('jYYYY/jMM/jDD')}
     تا
     ${moment(date2).format('jYYYY/jMM/jDD')}
     `;
     element.innerHTML=text;
 }


</script>

{% endblock %}