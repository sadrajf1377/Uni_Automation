{% extends 'Base_Layout.html' %}

{% block title %}
کارنامه ترم
{% endblock %}
{% block dynamic_style %}
<style>
        table{
            height: fit-content;width: 60%;border: none;margin-left: 20%;
            margin-top: 5%;border-radius: 1.5%;display: flex;flex-direction: column;
        }
        tr{
            height: fit-content;width: 100%;display: flex;flex-direction: row-reverse;
        }
        tr.semester{
            height: fit-content;width: 100%;display: flex;flex-direction: row-reverse;margin-top: 10vh;
        }
        td{
            height: fit-content;width:25%;font-size: calc(1vh + 1vw);border: 1px whitesmoke solid;border: 1px solid black;
            text-align: center;
        }
        td:nth-child(1n){background-color: lightgray;color:black}
        td:nth-child(2n){background-color: whitesmoke;color: black}
        form#appeal_form{
            height: fit-content;width: 60vw;position: fixed;left:20vw; top:15vh;border: none;box-shadow: 5px 5px 5px lightgray;
            font-size: calc(2vh);transition: transform 0.5s ease;text-align: center;
        }
        form#appeal_form>input,textarea,select,option,button{
            height: fit-content;width: 50%;border: none;border-radius: 5%;box-shadow: 5px 5px 5px lightgray;margin-left:25%;resize: none;
        }
    </style>
{% endblock %}
{% block main_content %}
    <form id="appeal_form" style="transform: scale(0)">
    {% csrf_token %}
    {% for field in appeal_form %}
    {{ field.label }}
        <br>
        {{ field }}
        <br>

    {% endfor %}
    <button onclick="event.preventDefault();submit_score_appeal()">
        ثبت اعتراض
    </button>
    <button onclick="event.preventDefault();open_close_appeal_form('-1')">
        بستن فرم
    </button>
    </form>
<table>
    {% for sem in semesters %}

         <tr class="semester">
        <td >
            نیمسال
        </td>
        <td class="sem_dates">
            {{ sem.start_date }}
        تا
        {{ sem.end_date }}

        </td>

    </tr>
        <tr>
        <td>نام درس</td>
        <td>تعداد واحد</td>
        <td>استاد</td>
        <td>نمره درس</td>
        <td>وضعیت قبولی</td>
        <td>اعتراض به نمره</td>
    </tr>
        {% for course in sem.sem_courses %}
            <tr>
             <td>{{ course.title }}</td>
        <td>{{ course.credits }}</td>
        <td>{{ course.teacher }}</td>
        <td>{{ course.score }}</td>
            <td>{{ course.pass_status }}</td>
            <td>
                {% if course.appeal_text %}
                {{ course.appeal_text }}
                    {% else %}
                    <p onclick="open_close_appeal_form('{{ course.id }}')">
                    ثبت اعتراض به نمره
                    </p>
                {% endif %}
            </td>
            </tr>
            {% endfor %}

         <tr>
          <td>معدل ترم</td>
         <td>{{ sem.sem_average }}</td>
         </tr>
    {% endfor %}
     <tr class="semester">
         <td>
             معدل کل نیمسال ها
         </td>
         <td>
             {{ total_average }}
         </td>
     </tr>
</table>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/moment@2.29.4/moment.js"></script>

<!-- بعد moment-jalaali -->
<script src="https://unpkg.com/moment-jalaali@0.9.2/build/moment-jalaali.js"></script>



<script>

  moment.loadPersian();
  const appeal_form=document.querySelector('form#appeal_form');
  let course_to_appeal_id='';
  const csrf_token=document.getElementsByName('csrfmiddlewaretoken')[0].value;
  function open_close_appeal_form(score_id)
  {
      const should_close_form=score_id=='-1';
      course_to_appeal_id=should_close_form?course_to_appeal_id:score_id;
      appeal_form.style.transform=should_close_form?'scale(0)':'scale(1)';
  }
  function submit_score_appeal()
  {
      const data=new FormData(appeal_form)
    fetch('submit_appeal/'+course_to_appeal_id,{method:"POST",body:data,headers:{"X-csrftoken":csrf_token}}).then(res=>res.json()).then(res=>{
        console.log(res)
    }).catch(res=>{console.log(res)})
  }
 const dates=document.querySelectorAll('.sem_dates');
 for (const element of dates){
     const dates_split=element.innerHTML.split('تا');
     const date1 = new Date(dates_split[0]);
     const date2 = new Date(dates_split[1]);
     const text=`
     از
     ${moment(date1).format('jYYYY/jMM/jDD')}
     تا
     ${moment(date2).format('jYYYY/jMM/jDD')}
     `;
     element.innerHTML=text;
 }


</script>

{% endblock %}