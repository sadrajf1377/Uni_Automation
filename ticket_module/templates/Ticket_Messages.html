{% extends 'Base_Layout.html' %}

{% block title %}
تیکت های من
{% endblock %}

{% block dynamic_style %}
<style>
form#message_form{
    width: 50vw;
    margin: 12vh auto;
    padding: 2rem 0;
    border: none;
    border-radius: 16px;
    background: rgba(255,255,255,0.18);
    backdrop-filter: blur(8px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    display: flex;
    flex-direction: column;
    direction: rtl;
    text-align: center;
    font-size: 1rem;
}

form#message_form> input,
form#message_form> select,
form#message_form > textarea{
    width: 60%;
    margin: .7rem auto;
    padding: .6rem .8rem;
    border: none;
    border-bottom: 1px solid #ccc;
    border-radius: 6px;
    background: rgba(255,255,255,0.35);
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    outline: none;
}

form#message_form > input:focus,
form#message_form> select:focus,
form#message_form> textarea:focus{
    border-bottom: 1px solid #007acc;
}

form#message_form button{
    width: 60%;
    margin: 1rem auto;
    padding: .7rem;
    border: none;
    border-radius: 10px;
    background: #007acc;
    color: white;
    font-size: 1.1rem;
    cursor: pointer;
    transition: .3s;
}
form#message_form button:hover{
    background: #198fff;
}

/* messages */
#messages_container{
    width: 60vw;
    margin: 3vh auto;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    direction: rtl;
    font-size: 1rem;
}

#messages_container > div.message{
    background: rgba(255,255,255,0.25);
    backdrop-filter: blur(6px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    border-radius: 14px;
    padding: 1rem;
    width: 70%;
    margin-right: auto;
}

.message > p{
    cursor: pointer;
    color: #007acc;
    font-weight: bold;
}

/* responses */
.responses_container{
    width: 100%;
    margin-top: 1rem;
    display: none;
}

.response{
    width: 85%;
    margin: .6rem auto;
    padding: .8rem;
    background: rgba(230,230,230,0.6);
    backdrop-filter: blur(4px);
    border-radius: 12px;
    position: relative;
    box-shadow: 0 2px 6px rgba(0,0,0,0.18);
}

.response > button{
    position: absolute;
    top: 6px;
    left: 6px;
    border: none;
    padding: .3rem .6rem;
    background: #d62828;
    color: white;
    border-radius: 6px;
    cursor: pointer;
}

/* mobile */
@media(max-width:768px){
    form#ticket_form{
        width: 90vw;
    }
    form#ticket_form > input,
    form#ticket_form > select,
    form#ticket_form > textarea{
        width: 85%;
    }
    #messages_container{
        width: 90vw;
    }
    #messages_container > div.message{
        width: 90%;
    }
}

</style>

{% endblock %}

{% block main_content %}
    <form id="message_form">
    {% csrf_token %}
    ثبت پیام جدید
    <br>
    {% for field in message_form %}
    {{ field.label }}
        <br>
        {{ field }}
        <br>
    {% endfor %}
    <button onclick="event.preventDefault();write_message()">
        ثبت پیام
    </button>
    </form>
<section id="messages_container">
پیام  های من
{% for message in messages %}
<div class="message">
شما گفتید:
<br>
{{ message.text }}
<br>
{{ message.date }}
<br>
<p onclick="open_close_replies(this)">
   نمایش پاسخ ها
</p>
<div class="responses_container" >
    {% for response in message.sup_responses %}
        <div class="response">
          {{ response.text }}
        <br>
        {{ response.date}}
        {% if not response.is_read %}
         <button onclick="mark_as_read(this,'{{ response.id }}')">
         خواندم
         </button>
        {% endif %}
        </div>
        {% endfor %}
</div>
</div>

{% endfor %}
</section>

{% endblock %}
{% block scripts %}
<script>

const message_form=document.getElementById('message_form');
const csrf_token=message_form.querySelector('[name=csrfmiddlewaretoken]').value;
const messages_container=document.getElementById('messages_container');
function open_close_replies(el)
{
    const container=el.parentElement.querySelector('div.responses_container');

    const is_open=container.style.display=='block';
    console.log('sds',is_open,container.style.display)
    container.style.display=is_open?'none':'block';
    el.innerText=!is_open?'پنهان کردن پاسخ ها':'نمایش پاسخ ها'

}
function mark_as_read(button,response_id)
{
    const data=new FormData();
    data.append('response_id',response_id)
    fetch('{% url 'mark_response_as_read' %}',{method:"POST",body:data,headers:{'X-csrftoken':csrf_token}}).then(res=>res.json()).then(res=>console.log(res)).catch(
        res=>console.log(res)
    )
}
async function write_message()
{
const response=await fetch('{% url 'write_ticket_message' %}',{method:"POST",headers:{'X-csrftoken':csrf_token},body:new FormData(message_form)});
const parsed_response=await response.json();
systemMessage.style.display='block';
systemMessage.querySelector('div#body').innerHTML=parsed_response.errors?parsed_response.errors:'' +'\n'+ parsed_response.message;
if(response.status==201)
{
    const message=document.createElement('div');
    message.className='message';
    message.innerHTML=`شما گفتید:
<br>
${parsed_response.message_content}
<br>
${parsed_response.date}
<br>`;
    const p=document.createElement('p');
    p.innerText='نمایش پاسخ ها';
    p.onclick=function (){open_close_replies(p)};
    const responses=document.createElement('div');
    responses.className='responses_container';
    message.appendChild(p); message.appendChild(responses)
    messages_container.appendChild(message);
}
}
</script>

{% endblock %}