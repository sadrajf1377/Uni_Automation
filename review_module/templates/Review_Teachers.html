{% extends 'Base_Layout.html' %}
{% load polls_extra %}

{% block title %}ارزیابی اساتید{% endblock %}
{% block dynamic_style %}
<style>
/* جدول بررسی اساتید */
#review_table {
    width: 65vw;
    margin: 12vh auto 5vh auto;
    border-collapse: collapse;
    border-radius: 16px;
    overflow: hidden;
    background: rgba(255,255,255,0.18);
    backdrop-filter: blur(8px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    direction: rtl;
    text-align: center;
    font-family: 'Vazirmatn', sans-serif;
}

#review_table tr {
    display: flex;
    flex-direction: row-reverse;
}

#review_table td {
    flex: 1;
    padding: 0.8rem;
    font-size: 1.1rem;
    border: 1px solid rgba(255,255,255,0.35);
    color: #003b5c;
    background: rgba(255,255,255,0.15);
}

/* رنگ ردیف‌ها */
#review_table tr:nth-child(odd) td {
    background-color: rgba(255,255,255,0.25);
}
#review_table tr:nth-child(even) td {
    background-color: rgba(255,255,255,0.12);
}

/* ستون آخر باریک‌تر برای متن سوال */
#review_table td:last-child {
    flex: 2;
    text-align: right;
    padding-right: 1rem;
}

/* input ها */
#review_table input[type="checkbox"] {
    width: 1.2rem;
    height: 1.2rem;
    cursor: pointer;
}

/* دکمه‌ها */
#review_table button {
    width: 100%;
    padding: 0.6rem 0;
    border: none;
    border-radius: 12px;
    background: rgba(0,122,204,0.75);
    color: black;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
}

#review_table button:hover {
    background: #1e90ff;
}

/* hover روی سلول‌ها */
#review_table td:hover {
    background: rgba(255,255,255,0.35);
    transition: 0.25s;
}

/* موبایل */
@media(max-width: 768px){
    #review_table {
        width: 90vw;
    }
    #review_table td {
        font-size: 0.9rem;
        padding: 0.5rem;
    }
    #review_table td:last-child {
        flex: 1.5;
    }
    #review_table button {
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}

{% block main_content %}

<table id="review_table">
<tr>
    <td>عالی</td>
    <td>خوب</td>
    <td>متوسط</td>
    <td>ضعیف</td>
    <td>خیلی ضعیف</td>

    <td></td>
</tr>
{% with 0|get_review_choices as choices %}
{% for rev in reviews %}
<tr>

   {% for r in choices  %}
       <td class="review_choice">
       <input type="checkbox" {% if r == rev.review %} checked {% endif %} oninput="check(this)" data-review_id="{{ rev.id }}" data-value="{{ r }}">
       </td>
       {% endfor %}
    <td>{{ rev.question.q_text }}</td>
</tr>

{% endfor %}
{% endwith %}
<tr >
    <td><button style="width: 100%;height: 100%;background-color: whitesmoke" onclick="submit_changes()">ثبت تغییرات</button></td>
    <td><form action="{% url 'close_review_session' %}" method="post" >{% csrf_token %}<input name="session_id" type="text" style="display: none" value="{{ review_session_id }}"><button style="width: 100%;height: 100%;background-color: lightgray">تایید نهایی</button></form></td>
</tr>
</table>

{% endblock %}
{% block scripts %}
<script>
function check(elm)
{
    const parent=elm.parentElement.parentElement.querySelectorAll('td.review_choice');
    for(const td of parent)
    {

        const inp=td.querySelector('input');

        inp.checked=inp===elm;
    }
}
const csrf_token=document.getElementsByName('csrfmiddlewaretoken')[0].value;
function submit_changes()
{

    const review_table=document.getElementById('review_table');
    const reviews_answers={};

    const  inps=review_table.querySelectorAll('input:checked');
    for(const inp of inps){
        reviews_answers[inp.getAttribute('data-review_id')]=inp.getAttribute('data-value')
    };
    console.log(reviews_answers)
    const json_data=JSON.stringify({'review_session_id':'{{review_session_id}}','reviews_answers':reviews_answers})
    fetch('{% url 'update_review_session' %}',{headers:{'X-csrftoken':csrf_token,'Content-Type': 'application/json'},body:json_data,method:'POST'}).then(res=>res.json()).then(res=>console.log(res)).catch(res=>console.log(res))
}
</script>
{% endblock %}